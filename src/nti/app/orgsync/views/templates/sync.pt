<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:metal="http://xml.zope.org/namespaces/metal"
	  xmlns:tal="http://xml.zope.org/namespaces/tal">
	<head metal:use-macro="macro:orgsync_head">
		<metal:slot fill-slot="title">
			<title>OrgSync</title>
		</metal:slot>
	</head>
	<body>
		<div class="col-sm-offset-1">
			<div>
				<label>Accounts:</label>
				<label id="accounts" tal:content="options/accounts">0</label>
			</div>
			<div>
				<label>Organizations:</label>
				<label id="organizations" tal:content="options/organizations">0</label>
			</div>
			<div>
				<label>Entries:</label>
				<label id="entries" tal:content="options/entries">0</label>
			</div>
			<div>
				<label>Last Entry:</label>
				<label id="last_entry" tal:content="options/last_entry"></label>
			</div>
			<form class="form-horizontal" action="" method="" id="sync_form">
				<button type="button" data-toggle="modal" data-target="#syncModal">Synchronize</button>
			</form>
		</div>
		<div class="modal fade" id="syncModal" role="dialog"
			tal:attributes="url options/sync_url" >
			<div class="modal-dialog">
				<form class="form-horizontal" action="" method="POST" id="publish_form">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal">&times;</button>
							<h4 class="modal-title" metal:define-slot="publish_modal_title">Are you sure you want to sync?</h4>
						</div>
						<div class="modal-body">
							<div class="form-group col-sm-offset-1">
								<label class="control-label col-sm-2">Start:</label>
								<div class="col-sm-5">
									<div class='input-group date' id='begin_datetimepicker'>
										<input class="form-control" id="target_begin_date" name="target_begin_date"></input>
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>
							<div class="form-group col-sm-offset-1">
								<label class="control-label col-sm-2">End:</label>
								<div class="col-sm-5">
									<div class='input-group date' id='end_datetimepicker'>
										<input class="form-control" id="target_end_date" name="target_end_date"></input>
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-primary" id="confirm_sync_button">Confirm</button>
							<button type="button" class="btn btn-default" data-dismiss="modal" id="cancel_sync_button">Cancel</button>
						</div>
					</div>
				</form>
			</div>
		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
		<script type="text/javascript">
			$('#begin_datetimepicker').datetimepicker({
				format: "YYYY-MM-DD"
			}).on("dp.change", function(e){
				$('#publish_form').bootstrapValidator('revalidateField', 'target_begin_date');
			});

			$('#end_datetimepicker').datetimepicker({
				format: "YYYY-MM-DD",
			}).on("dp.change", function(e){
				$('#publish_form').bootstrapValidator('revalidateField', 'target_end_date');
			});
			function doSync() {
				// Get URL
				var url = $('#syncModal').attr('url');
				// Run job
				return new Promise((success, failed) => {
					document.getElementById("cancel_sync_button").setAttribute('disabled', true);
					document.getElementById("confirm_sync_button").setAttribute('disabled', true);
					$.ajax({
						url: url,
						method: 'POST',
						data: {},
						success: function(data, status, jqXHR) {
							success();
						},
						error: function(jqXHR, exception) {
							failed(exception);
						}
					});
				});
			}
			$('#confirm_sync_button').on('click', function(e) {
				e.preventDefault();
				e.stopPropagation();
				$('#indicator').show();
				doSync()
					.catch((e) => {
						console.log(e);
					})
					.then(() => {
						document.getElementById("cancel_sync_button").removeAttribute('disabled');
						document.getElementById("confirm_sync_button").removeAttribute('disabled');
						$('#syncModal').modal('hide');
						location.reload(true);
					});
			});
		</script>
	</body>
</html>
